# Storage基礎

## 担当
---
**野田さん**
 - 北海道全域のお客様機器の保守導入作業、GPU機器要員化に向け勉強中
  
**新保さん**
 - PureStorage製品の主管業務
---

## 到達目標
 - システムにおけるStorageが持つ役割を理解する
 - Storageの構成要素について理解する
 - Storageの接続形態(DAS、NAS、SAN)について理解する
 - HDDとSSDの違いについて理解する

---

## 1. Storage概要

### Storageとは
#### **Storage** ：データを置く場所（倉庫）、HDD、SSDなど
  - RAIDコントローラを強化、独立させた装置
  - メリット
    - 冗長化構成により無停止稼働
    - 複数のServerに接続するため容量を効率よく使える
    - 遠隔地、差分バックアップ等の独自機能による付加価値
    - 優れたパフォーマンス
      - より優れたCPU
      - より大容量のメモリ
      - より多くのドライブ搭載数
      
 #### 使命
- **データ保護** ：保管されているものを守る
- **サービスの継続**　：いつでも使える
- **十分な性能**　：データを素早く出し入れできる
 ---

### 記憶装置
 1000倍早い主記憶装置のみで構成できるのが理想だが....
  
| 名                   | 例 | 特徴                       | 価格 |
|----------------------------|------------|--------------------------------|--------|
| 主記憶装置         | DRAM        | `高価` `低容量` `揮発性`   | 16GB -> ¥8000  |
| 補助記憶装置             | HDD等        | `安価` `大容量` `不揮発性`  | 8TB -> ¥15000 |

 遅い補助記憶装置を加速するために工夫がされている
  - キャッシュメモリ：高速化
  - RAID：大容量化、高速化、冗長化
  - SSD：高速化
  - 仮想化：大容量化、高速化、効率化

---

### 実体
- OS(ほとんどがCustomizeLinux、Windows)とCPU、メモリ、HDDで動く　->　Serverと同じ
  - StorageはServerをベースに最適化したもの
  - Storage処理に特化したHWで構築される
- 増設する場合
  - **スケールアップ** ：容量のみ拡張可能
  - **スケールアウト** ：ノード（CPU + 容量)を拡張

#### 用途別

| 名                   | 特徴                       | 
|----------------------------|------------|
| ブロックStorage      | `内蔵ディスクと同じ感覚で使用可能` `SANブート可能`      |
| ファイルStorage             | `ファイル共有OSを搭載` `豊富なファイル共有機能`        | 
| オブジェクトStorage          | `大量,大容量コンテンツ配信/保存向け` |

#### 使用ドライブ別

| 名                   | 特徴                       | 
|----------------------------|------------|
| オールフラッシュStorage      | 全てフラッシュ(SSD)で構成 `高速` `やや高価`|
| ハイブリッドStorage             | HDDとSSDの混在で構成 `性能とコスパを両立`        | 
| HDD Storage          | 全てHDDで構成 `長年の実績` `ニアラインによる大容量化` |


---

## 2. HDD Storage

### 種類

| 名         | 正式名                       | 特徴 | 用途 |
|----------------------------|------------|-------|--------|
| SAS-HDD    | Serial Attached SCSI | `高性能` `高信頼性` `高価` | DB,仮想基盤,本番AP等 |
| SATA-HDD   | Serial ATA | `低性能` `低信頼性` `安価` | ファイル共有,開発用途 |
| NL-SAS     | Nearline-SAS | `低性能` `低信頼性` `安価` | ファイル共有,開発用途 |

- `制御基板(裏側)` ：HDDコントローラ、キャッシュメモリ、モニタードライバ
- `インターフェース`/`電源コネクタ` ：インターフェースはSASとSATA
- `アクチュエータ` ：ヘッドの位置を決める
- `スピンドルモータ` ：プラッタを回転させるモータ
- `スイングアーム` ：ヘッドを左右に動かす、ここのモータはシークモータと呼ぶ
- `磁気ヘッド` ：データを読む時期リーダとかく電磁石
- `プラッタ(磁気ディスク)` ：データが書きもまれる磁気を帯びた円盤

---

### 動き

#### 読み書きにかかる時間 = シークタイム + サーチタイム + データ転送時間

- **シーク** ：磁気ヘッドが目的のデータトラックに移動する時間
- **サーチ** ：目的のデータポジションが磁気ヘッドに回ってくるまでの時間
- **データ転送** ：目的のデータを転送(磁気ヘッドで読み書き)する時間

- データトラック：ぴらった上にある円状の記憶領域。トラックを分割した最小記憶単位は**セクタ**

#### アクセス(読み書き)方法

HDDは円盤であるが故にランダムアクセスが苦手

SSDはランダムアクセスも得意

| 名                   | 特徴                       | ---|
|----------------------------|------------|----------|
| シーケンシャルアクセス     | 順番に並んだデータにアクセス `高速`| 得意 | 
| ランダムアクセス           | ばらばらに配置されたデータにアクセス `低速`        | 不得意 |

---

### RAID

- ミラーリング：まったく同じデータを記憶(RAID1)
- ストライピング：RAIDを構成するドライブに分散
- SW RAID：独自のRAIDルールに基づきデータを保護

- ストライプ幅
  - データを分散させるドライブの数
  - RAID5 , RAID6 , RAID10 に当てはまる
  - 大きいほど**高性能**

- パリティ
  - 1台のディスクが故障した場合、残りのディスクとパリティ情報を用いて故障ディスクのデータを復旧できる
  - ストライピングでデータ部分から計算
  - `ライトペナルティ` ：計算が発生するためミラーリングより速度が少し落ちること
  - `RAID6` ：パリティ2つ、2本のディスク障害に対応
  - `RAID5` ：パリティ1つ、1本のディスク障害に対応
 
---

## 3. Storageアーキテクチャ

### 構成要素

| 名 | 構成要素 | 正式名 | 特徴 | 
|------|--------|----------|----------|
| シャーシ | 外殻 + ミッドプレーン(各構成要素を接続する中継基盤) | --- | --- | 
| Storage | シャーシ + 各構成要素(コントローラ + 電源 + HDD etc...) | --- | --- |
| SPOF(ミッドプレーン) | --- | Single Point of Failure | 単一故障点：ここで即時停止 `低故障率` |
| コントローラ | HW構成：デュアルコントローラ | High Availability | 同時稼働による `負荷分散` `集中処理` |

- HW
  - 障害時はパフォーマンスが低下
  - コントローラ同士は内部 or 外部の高速パスでつながる
  - オンライン交換可能
  - 専用設計が多いがServerにも流用される
  - ServerはMPOI等でパスを管理
    
- コントローラの構成要素：`CPU` `メモリ` `NVRAM` `各種インターフェース`

---

### CPU/メモリ

- CPU
  - Storage OS, RAID管理, Parity計算, 各種機能を実行するための演算処理
  - Server搭載のCPUのイメージは同じで多くは `Intel Xeon`

- メモリ
  - OS, 各種機能用のメインメモリ, Read/Writeキャッシュ用のメモリ
  - RAMが用いられ, HighEndモデルは大容量(数十GB - 数百GB)
  - CPUを待たせないよう, キャッシュメモリを中断させて読み書きを行うことで高速化
  - Write Through：キャッシュを使用せずHDDに直接書きこんでからCPUに書き込み完了応答
  - Write Back：キャッシュにいったん書き込みCPUに完了を返答。空いた時間にHDDに書き込み
 
- キャッシュメモリ
  - キャッシュ, データロスト：HDD未書き込みのデータが消える場合あり
  - キャッシュメモリ2重化(障害に備える)：2つのコントローラ両方のキャッシュにデータを書き込んでから完了応答
  - バッテリーによる保護(停電に備える)：停電時にバッテリーから電気を供給することでキャッシュ揮発を阻止
  - NVRAM(Non-Volatile-RAM：不揮発性RAM)
    - 1つのコンポーネント
    - Writeキャッシュとして使用される
    - 揮発性メモリであるRAMをバッテリで不揮発化、停電時はSSDへ退避
  - バッテリ
    - NVRAMを使用しないStorageはバッテリでRAMを保護
    - メインメモリでRead/Writeキャッシュ, システムをすべて賄う

---

### ドライブ

- 特徴
  - サイズ：高速HDD/SSDは2.5inch, 低速大容量HDDは3.5inch
  - 搭載数：2.5inchは24本, 3.5inchは12本が主流(シャーシサイズは同じ)
  - コントローラシャーシを搭載数以上に増やしたい場合は拡張筐体を使用

- 拡張筐体
  - HDD/SSD, 拡張筐体　<->　コントローラの接続はSASが主流
  - 複数の拡張筐体を接続する場合は経路に注意
    - Bus(EMC), Stack(NetApp)
    - SASケーブルは6, 12Gbpsの帯域上限
    - 経路を分けることで帯域を増やすことが可能
   
- フロント, バックエンド
  - フロントエンド：Serverへの接続向け, StorageとServerをつなぐ
  - バックエンド：拡張筐体へ接続向け

|  | フロントエンド | バックエンド |
|---|----|-------|
| 規格 | `FC` `iSCSI` | `SAS` |
| ケーブル | `FCケーブル` `LANケーブル` | `SASケーブル` |
| 帯域 | `FC：8/16/32/64/(128)Gbps` `iSCSI：1/10/25/40/(100/400)Gbps` | 6Gbps/12Gbps |
|接続先 | `FCスイッチ` `ネットワークスイッチ` `Server(直接接続の場合)` | 拡張筐体 |

---

## 4. Tape Storage

### Tape

- HDDより `安価` `大容量` `長期保管可能` で根強いニーズがある
  - 安価：カートリッジが安い, 未使用時の電力が不要, 買い替え回数が少ない
  - 長期保存：環境や使用回数に左右されるが5 - 30年
- 企業には文章の保存期間が法律で定められており高価なStorageや信頼性の低い装置に保管することは得策ではない
- 遠方のバックアップセンターにメディアを**輸送**できるのも強み
  - 専用ボックス, 精密機器輸送業者の輸送可能
- バックアップのみで使用される
  - 採取量：`フルバックアップ` `増分バックアップ` `差分バックアップ`
  - 業務サーバーの負荷軽減
  - バックアップ用ソフトウェアが必要： `NetBackup` `Backup Exec` `Arcserve` など
- 構成要素
  - 記憶媒体：テープメディア
  - 読み書き装置：テープドライブ
    
---

### LTO
- 現在主流のテープ
- LTO：Linear Tape-Open
- LTO9（2025年現在の最新機種）
  - 容量：18TB（最大圧縮時45TB)、(LTO10では圧縮時90TBを予定）
  - 輸送レート：400Mbps（最大圧縮時1000Mbps)
  - 価格：¥30000程度
- 構成要素
  - 記憶媒体：LTOカートリッジ
  - 読み書き装置：LTOドライブ
  

---

### メディア
  - テープ内のデータ開始点, 終了点はBOT, EOTで判別
    - BOT：Beginning of tape
    - EOT：End of tape
  - 記録されるファイルは順番にテープに書き込まれEOFによってファイルの区切りが判別
    - EOF：End of file
  - 第るはブロックという単位で細切れにされ書き込まれ、ブロックの区切りはIRGにて判別
    - Block：128KB(LTO3以上)
    - IRG：Inter record gap
  - ブロックはLTOの規格で異なるが、LTO3- は128KB、LTO6-は256KB
  - バーコード
    - メディアの名前を表示
    - バックアップソフトからもバーコード名で管理可能
    
---

### ドライブインターフェース

- ライブラリと同様にドライブとServerをつないだパスに読み書きデータが流れる
- 最もポピュラーなのはFC
- Serverに内蔵する場合はSATAが一般的（DVDドライブと同じイメージ）
- iSCSIはあまり使用されない（仮想テープ装置[VTL]では使用されることもある）
- Serverに直結、FCスイッチでStorageネットワークSANを構成することも
  - ライブラリはFCスイッチ（SAN)が多い

---

### ライブラリ

- 役目
  - データの読み書き（ドライブ）
  - メディアの格納, 管理（マガジン, メールスロット）
  - メディア輸送（ロボット）
  - 複雑かつ複数のバックアップジョブを自動化
  - オートクリーン, 使用回数管理などの運用の自動化

 | 名 | 役割  | 
 |-------|-------|
 | メールスロット(I/Eステーション) | `メディアの出入り場所` |
 | オペレーションパネル | `タッチ操作` |
 | マガジン（格納セル) | `メディア格納場所` |
 | ロボット | `メディア輸送` `上下左右に動く` |
 | コントローラ(OS) | `制御機構` `Serverと接続` |
 |ドライブ(単数or複数) | `読み書き` ` 接続部(コネクタ)` | 

 ---

 ### 今後のテープ装置動向
- 法律で定められるデータ保管用途　->　従来通り
- コンプライアンス　->　新しい用途
  - WORM(Write once read many)：HW的に書き込みを一度しか認めないでデータ改ざんを防ぐ
  - 訴訟に備えた企業活動の長期記憶
- ビッグデータバックアップ　->　新しい用途
  - 企業活動におけるデータ量が伸びている一方、コールドデータも多い
  - 安価なStorageやCloudでもそれなりに高価
  - LTO10では1本で90TBの見込み
- VTL
  - 仮想テープ装置（Virtual Tape Library)
  - テープ StorageのようにふるまうHDD Storage
  - HDD上に仮想のテープドライブを作りバックアップを行う方法
  - テープ保管の紛らわしさから解放される

