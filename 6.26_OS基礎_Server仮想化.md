## Server仮想化

<br>

[1. Serverの仮想化とは](#Serverの仮想化とは)

[2. VMware製品によるServer仮想化](#VMware製品によるServer仮想化)

[3. vSphereのServer仮想化機能](#vSphereのServer仮想化機能)

---

- 藤本さん　仮想化オンプレ/Cloud設計構築 
- 村上さん　仮想化オンプレ/Cloud設計構築 -> バックアップSW
- 尾崎さん　仮想化 -> DELL設計構築

---

### 目的

- Server仮想化/VMware製品の基礎知識習得
- 仮想Serverのイメージを持つ
- Serverを仮想マシンにするメリット
  - リソースを無駄なく使える
  - メンテナンスしやすく障害対応できる（vMotion, HA)
- デメリット
  - 構成が複雑
  - 障害時の切り分けが大変

---

### Serverの仮想化とは

- コンピュータリソースをSWで抽象化して論理的に利用する技術
- リソースの柔軟性、SW上からのコンポーネント一元管理など自由度の大幅向上が見込める
- 導入業界：教育、金融などが顧客として多い

|名| 特徴|略語|
|------|------|-----|
|Server仮想化|物理マシンに搭載されたHWリソースを抽象化|`SDC`：Software Difined Compute|
|Storage仮想化|HDDなどの記憶媒体を抽象化|`SDS`：Software Difined Storage|
|NW仮想化|物理NWを抽象化|`SDN`：Software Difined Network|
|Client仮想化|Server仮想化技術をお応用してClient端末のデスクトップ環境を抽象化||

<br>

- `Hypervisor`：物理マシンのHWリソースを抽象化し、複数のOSがリソースを共有して利用できるよう管理するSW
  - 主なServer仮想化製品(当社はすべて取り扱い有)：
  - `ESXi(VMware社)` `Hyper-V(Windows OS標準機能)` `AHV(Nutanix社)` `HVM(HPE社 Ubuntu(Linux)KVM)`

#### 物理マシンとAppの構成（一般的）

- 物理Server一台にAppを一つ動かす
  - デメリット：`拡張による機器コスト増` `管理維持コスト増` `構築コスト増` `高スペックを最大限に活用不可`
- 物理Server一台にAppをnつ動かす
  - あまりない、一つのOSが落ちるとすべてのAppが落ちてしまう
- Server仮想化、物理Server一台にHypervisorをかまして1:1の仮想Serverをnつたてる
  - メリット：`1台のOSがクラッシュしてもほかのOSは正常に稼働`
 
#### 仮想Server実演

- OverleafのようなUI
- フォルダとファイルのような階層関係で構築
- どのStorageに配置するか決める
- PythonのVersionのようにOS, OS_Versionを選択
- HWのリソースのCustomize、無尽蔵に値は大きくできず物理マシンに比例する
- 容量は一般的に一割減衰するため 256GBならば約238GB（1024計算）

#### 仮想化のメリット/デメリット

- メリット
  - `物理マシンの機器/管理コストの削減`：従来だとOS4台に対し物理マシン4台が必要だったが、OS4台を1台に集結可能
  - `物理マシンリソースの有効活用`：Hypervisorより各Appごとの時間需要による余剰リソースを効率よく使用可能
  - `App構築時間短縮`：機種選定からケーブリングまでの手間が省けるため数時間で実装可能
  - `OSを止めずに物理マシンのパーツ交換`：メモリ交換時他の物理マシンへ移行が可能なためOSを稼働させたまま運用可能
  - `古いVersionのOSの延命`：Hypervisorが物理マシンにおいてサポート外のVersionに対応していれば物理マシンは考慮しなくてよくなる

<br>

- デメリット
  - `物理マシン障害時の影響`：物理マシンが停止した場合、その上のすべてのOSが停止する
  - `ディスクのI/OやNWのトラフィックが集中`：OSやAppのパフォーマンス低下
  - `設計/導入/運用の複雑化`：Hypervisorも含めたシステム全体の専門的な知識が必要
  - `障害発生時原因特定のための切り分け`：障害内容/システム構成を把握した切り分けが必要
 
- 対策
  - `電源の冗長化` `フェイルオーバー` `DR(災害機能)` `RAID1のように同じ内容のServerを複数立てる`
  - `大量データ処理には仮想化を使用しない` `トラフィックが集中するOSは同じ物理マシンに置かない`
  - `仮想化に必要な技術は多いためどの分野に進むにしてもメリット`
  - `UALの保守契約がある場合はコールセンターへ` -> `サポート製品担当者間で連携しながら対応`

 
---

### VMware製品によるServer仮想化

#### vSphere

VMware社が提供しているServer仮想化サービス

<br>

- `ESXi`：物理マシンに直接インストールする仮想マシン作成管理Hypervisor
- `vCenter Server`：複数台のESXiホストを管理するServerで仮想化ならではの機能が使える
- `Host Client`：
  - 操作端末にSWインストール不要でWebブラウザから接続する
  - ESXiやESXi上で稼働する仮想マシンの設定変更/状態管理をしパワーオンなどの役割を持つ
- `vSphere Client`：
  - 操作端末にSWインストール不要で操作端末のブラウザから接続
  - vCenter Server/ESXi/仮想マシンの設定変更/状態管理をし特有の機能設定/操作をする(HA,vMotion等)
- `VMware Tools`：
  - ゲストOSにインストールして仮想環境荷最適化されたNICなどのドライバーや時刻同期などを行うToolsサービス
  - ゲストOS上のマウス操作がなめらかになるとともに自動でOSの障害検知が可能
  - VMware Toolsをインストールしないとサポートされないため**必ず導入**

  
  <br>

||パーティーの場合|Serverマシンの場合|OSの機能|
|------|------|-----|-----|
|ホストOS|招く側|おおもとのマシン|ゲストOSのために機能や場所を提供する|
|ゲストOS|招かれる側|おおもとのマシン上で動く仮想マシン|ホストOSとは異なるOS, Versionで動作可能|

<br>


  
---

### vSphereのServer仮想化機能

#### ESXiの機能

|ESXi単体の機能||
|-------|------|
|`仮想マシン` `ゲストOSの電源操作`|安全なシャットダウンはゲストOSから<br>仮想マシンのパワーオン、オフ、サスペンド、リセット|
|`OVF(Oprn Virtualization Format`|構成情報やゲストOSのデータをOVFファイルとして外部にExport(仮想マシンの停止必須)<br>ファイルは別のESXiにimport可能|
|`スナップショット`|ある時点の情報を保持する機能<br>ロルバが可能|

<br>

- スナップショットで保持される仮想マシンの情報：`電源状態` `CUP/メモリ状態` `ディスク(bmdkファイ)の状態`
- スナップショットの注意点：長期間スナップショットのままにするとデータの劣化、I/O負荷が大きくなるため24-72時間以内に要消去


<br>

#### vCenter Serverの機能

- `Clone`：
  - 仮想マシンがパワーオンの状態でもコピー/Cloneを作成することが可能
  - コピー作成時、ゲストOSのコンピュータ名/IPアドレスなどのCustomizeが可能
- `Template`：
  - 複数の仮想マシーンをコピーするときに適している
  - 仮想マシンをTemplateに変換しTemplateから仮想マシンのコピーを作成
  - コピー作成時、ゲストOSのCustomizeが可能
- `vMotion`：
  - あるESXi上で稼働している仮想マシンを他のESXi上に無停止で移動する機能
  - メンテナンス時の対応の際に利用
- `Storage vMotion`：
  - 仮想マシンファイルを別のデータストアに移行
  - メリット：`データストアの空き容量確保` `メンテ対応` `仮想ディスクのプロビジョニングタイプの変更`
- `vSphere HA`：
  - ESXiでHW/Storage障害発生時、正常なESXi上に自動で再起動させる機能
 

|機能名|機能|使用目的|設定(箇所)|ダウンタイム|操作|
|------|------|-------|-------|------|------|
|vMotion|ESXi間のVMの無停止移行|物理マシンの計画停止|VM単位|なし|手動|
|Storage vMotion|Storage間のVMのデータの無停止移行|Storageの計画停止/空き容量確保|VM単位|なし|手動|
|vSphere HA|ESXi障害時のVMのフェイルオーバー機能|物理マシンの障害対策|クラスタ単位|数分|自動|

<br>

- vMotionの動作
  - 1. 移行先のESXiに仮想マシンエントリ作成
    2. 仮想マシンのメモリを移行先にNW経由でコピー
    3. 上記のコピー中の差分メモリをコピー
    4. a-cを繰り返し実行しメモリサイズが一定量を下回るまで実行
    5. 一時的に仮想マシンを止めて最後のメモリをコピーして完全移行
